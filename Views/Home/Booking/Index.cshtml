@model Event

@{
    ViewData["Title"] = "Book - " + Model.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking.css">
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-7">
            <div class="event-details-card">
                <div class="event-header">
                    <div class="event-category">
                        <i class="bi bi-tag-fill"></i>
                        @if (Model.Category != null)
                        {
                            <span>@Model.Category.Name</span>
                        }
                    </div>
                    <h2 class="event-title text-white">@Model.Title</h2>
                    <div class="event-meta">
                        <div class="meta-item">
                            <i class="bi bi-calendar3"></i>
                            <span>@Model.StartDateTime.ToString("dddd, MMMM dd, yyyy")</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-clock"></i>
                            <span>@Model.StartDateTime.ToString("HH:mm") - @Model.EndDateTime.ToString("HH:mm")</span>
                        </div>
                        <div class="meta-item">
                            <i class="bi bi-geo-alt-fill"></i>
                            <span>
                                @if (Model.Location != null)
                                {
                                    @Model.Location.Name
                                    <text>, </text>
                                    @Model.Location.City
                                }
                                else
                                {
                                    <text>Location TBD</text>
                                }
                            </span>
                        </div>
                    </div>
                </div>

                @if (Model.AllImagePaths.Any())
                {
                    <div class="event-poster">
                        <img src="@Model.AllImagePaths[0]" alt="@Model.Title" class="img-fluid">
                    </div>
                }

                <div class="event-description">
                    <h4>About This Event</h4>
                    <p>@Model.Description</p>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="booking-panel">
                <div class="panel-header">
                    <h3>
                        <i class="bi bi-ticket-perforated"></i>
                        Select Your Seats
                    </h3>
                </div>

                <!-- Ticket Summary -->
                <div class="ticket-summary-section" id="ticketSummarySection">
                    <h4>Selected Tickets</h4>
                    <div id="selectedTicketsList" class="selected-tickets-list">
                        <!-- Selected tickets will be displayed here -->
                    </div>
                    <div class="total-amount">
                        <strong>Total: <span id="bookingTotalAmount">LKR 0</span></strong>
                    </div>
                </div>

                <!-- Booking Panel (No Form Needed) -->

                    <div class="seat-selection-container">
                        <div class="screen-indicator">
                            <div class="screen-text">SCREEN</div>
                            <div class="screen-curve"></div>
                        </div>

                        <div class="seat-map" id="seatMap">
                            <!-- Row A -->
                            <div class="seat-row">
                                <span class="row-label">A</span>
                                <div class="seats">
                                    <div class="seat" data-seat="A1" data-price="5000">A1</div>
                                    <div class="seat" data-seat="A2" data-price="5000">A2</div>
                                    <div class="seat" data-seat="A3" data-price="5000">A3</div>
                                    <div class="seat" data-seat="A4" data-price="5000">A4</div>
                                    <div class="seat" data-seat="A5" data-price="5000">A5</div>
                                    <div class="seat" data-seat="A6" data-price="5000">A6</div>
                                    <div class="seat" data-seat="A7" data-price="5000">A7</div>
                                    <div class="seat" data-seat="A8" data-price="5000">A8</div>
                                </div>
                                <span class="row-label">A</span>
                            </div>

                            <!-- Row B -->
                            <div class="seat-row">
                                <span class="row-label">B</span>
                                <div class="seats">
                                    <div class="seat" data-seat="B1" data-price="5000">B1</div>
                                    <div class="seat" data-seat="B2" data-price="5000">B2</div>
                                    <div class="seat" data-seat="B3" data-price="5000">B3</div>
                                    <div class="seat" data-seat="B4" data-price="5000">B4</div>
                                    <div class="seat" data-seat="B5" data-price="5000">B5</div>
                                    <div class="seat" data-seat="B6" data-price="5000">B6</div>
                                    <div class="seat" data-seat="B7" data-price="5000">B7</div>
                                    <div class="seat" data-seat="B8" data-price="5000">B8</div>
                                </div>
                                <span class="row-label">B</span>
                            </div>

                            <!-- Row C -->
                            <div class="seat-row">
                                <span class="row-label">C</span>
                                <div class="seats">
                                    <div class="seat" data-seat="C1" data-price="4000">C1</div>
                                    <div class="seat" data-seat="C2" data-price="4000">C2</div>
                                    <div class="seat" data-seat="C3" data-price="4000">C3</div>
                                    <div class="seat" data-seat="C4" data-price="4000">C4</div>
                                    <div class="seat" data-seat="C5" data-price="4000">C5</div>
                                    <div class="seat" data-seat="C6" data-price="4000">C6</div>
                                    <div class="seat" data-seat="C7" data-price="4000">C7</div>
                                    <div class="seat" data-seat="C8" data-price="4000">C8</div>
                                </div>
                                <span class="row-label">C</span>
                            </div>

                            <!-- Row D -->
                            <div class="seat-row">
                                <span class="row-label">D</span>
                                <div class="seats">
                                    <div class="seat" data-seat="D1" data-price="3000">D1</div>
                                    <div class="seat" data-seat="D2" data-price="3000">D2</div>
                                    <div class="seat" data-seat="D3" data-price="3000">D3</div>
                                    <div class="seat" data-seat="D4" data-price="3000">D4</div>
                                    <div class="seat" data-seat="D5" data-price="3000">D5</div>
                                    <div class="seat" data-seat="D6" data-price="3000">D6</div>
                                    <div class="seat" data-seat="D7" data-price="3000">D7</div>
                                    <div class="seat" data-seat="D8" data-price="3000">D8</div>
                                </div>
                                <span class="row-label">D</span>
                            </div>
                        </div>

                        <div class="seat-legend">
                            <div class="legend-item">
                                <div class="seat-sample available"></div>
                                <span>Available</span>
                            </div>
                            <div class="legend-item">
                                <div class="seat-sample selected"></div>
                                <span>Selected</span>
                            </div>
                            <div class="legend-item">
                                <div class="seat-sample occupied"></div>
                                <span>Occupied</span>
                            </div>
                        </div>
                    </div>

                    <div class="selected-seats-summary" id="selectedSeatsContainer" style="display: none;">
                        <h4>Selected Seats</h4>
                        <div id="selectedSeatsList"></div>
                    </div>

                    <div class="booking-summary" id="bookingSummary" style="display: none;">
                        <h4>Booking Summary</h4>
                        <div class="summary-items" id="summaryItems"></div>
                        <div class="summary-total">
                            <div class="total-row">
                                <span>Total Amount:</span>
                                <span class="total-price" id="totalPrice">LKR 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="booking-actions">
                        <button type="button" class="btn btn-book" id="proceedBtn" disabled onclick="proceedToPayment()">
                            <i class="bi bi-credit-card"></i>
                            Proceed to Payment
                        </button>
                        <div class="secure-notice">
                            <i class="bi bi-shield-check"></i>
                            <span>Your booking is secured with SSL encryption</span>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>

<!-- Include the booking JavaScript -->
<script>
    // Global variables
    let selectedTickets = [];
    let selectedSeats = [];
    let totalAmount = 0;
    let eventId = 0;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadSelectedTickets();
        initializeSeatSelection();
        updateBookingSummary();
    });

    function loadSelectedTickets() {
        // Get selected tickets from URL parameters or session storage
        const urlParams = new URLSearchParams(window.location.search);
        const selectedTicketsParam = urlParams.get('selectedTickets');
        
        if (selectedTicketsParam) {
            try {
                selectedTickets = JSON.parse(decodeURIComponent(selectedTicketsParam));
            } catch (e) {
                console.error('Error parsing selected tickets:', e);
                selectedTickets = JSON.parse(sessionStorage.getItem('selectedTickets') || '[]');
            }
        } else {
            selectedTickets = JSON.parse(sessionStorage.getItem('selectedTickets') || '[]');
        }

        totalAmount = parseFloat(sessionStorage.getItem('totalAmount') || '0');
        eventId = parseInt(sessionStorage.getItem('eventId') || '0');

        // Display selected tickets
        displaySelectedTickets();
    }

    function displaySelectedTickets() {
        const container = document.getElementById('selectedTicketsList');
        const totalAmountElement = document.getElementById('bookingTotalAmount');
        
        if (selectedTickets.length === 0) {
            container.innerHTML = '<p class="text-muted">No tickets selected</p>';
            return;
        }

        container.innerHTML = selectedTickets.map(ticket => `
            <div class="selected-ticket-item">
                <span class="ticket-name">${ticket.name}</span>
                <span class="ticket-quantity">x${ticket.quantity}</span>
                <span class="ticket-price">LKR ${(ticket.price * ticket.quantity).toLocaleString()}</span>
            </div>
        `).join('');

        totalAmountElement.textContent = `LKR ${totalAmount.toLocaleString()}`;
    }

    function initializeSeatSelection() {
        // Add click event listeners to seats
        document.querySelectorAll('.seat').forEach(seat => {
            seat.addEventListener('click', function() {
                if (this.classList.contains('occupied')) return;
                
                this.classList.toggle('selected');
                updateSelectedSeats();
            });
        });
    }

    function updateSelectedSeats() {
        selectedSeats = [];
        const selectedSeatElements = document.querySelectorAll('.seat.selected');
        
        selectedSeatElements.forEach(seat => {
            const seatId = seat.getAttribute('data-seat');
            const price = parseFloat(seat.getAttribute('data-price'));
            
            // Find matching ticket type based on price
            let ticketTypeId = 1; // Default
            selectedTickets.forEach(ticket => {
                if (ticket.price === price) {
                    ticketTypeId = ticket.ticketTypeId;
                }
            });

            selectedSeats.push({
                seatId: seatId,
                eventId: eventId,
                ticketTypeId: ticketTypeId,
                price: price
            });
        });

        updateBookingSummary();
    }

    function updateBookingSummary() {
        const proceedBtn = document.getElementById('proceedBtn');
        const selectedSeatsContainer = document.getElementById('selectedSeatsContainer');
        const selectedSeatsListElement = document.getElementById('selectedSeatsList');
        const bookingSummary = document.getElementById('bookingSummary');
        const summaryItems = document.getElementById('summaryItems');
        const totalPriceElement = document.getElementById('totalPrice');

        // Update selected seats display
        if (selectedSeats.length > 0) {
            selectedSeatsContainer.style.display = 'block';
            selectedSeatsListElement.innerHTML = selectedSeats.map(seat => `
                <div class="selected-seat-item">
                    <span class="seat-id">${seat.seatId}</span>
                    <span class="seat-price">LKR ${seat.price.toLocaleString()}</span>
                </div>
            `).join('');

            bookingSummary.style.display = 'block';
            
            // Calculate total with seat prices
            const seatTotal = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);
            summaryItems.innerHTML = `
                <div class="summary-item">
                    <span>Selected Seats (${selectedSeats.length})</span>
                    <span>LKR ${seatTotal.toLocaleString()}</span>
                </div>
            `;
            totalPriceElement.textContent = `LKR ${seatTotal.toLocaleString()}`;

            proceedBtn.disabled = false;
        } else {
            selectedSeatsContainer.style.display = 'none';
            bookingSummary.style.display = 'none';
            proceedBtn.disabled = true;
        }

        // Debug logging
        console.log('Updated booking data:');
        console.log('SelectedSeats:', JSON.stringify(selectedSeats));
        console.log('SelectedTickets:', JSON.stringify(selectedTickets));
        console.log('TotalAmount:', selectedSeats.length > 0 ? 
            selectedSeats.reduce((sum, seat) => sum + seat.price, 0) : totalAmount);
    }

    // Function to proceed to payment with URL parameters
    function proceedToPayment() {
        if (selectedSeats.length === 0) {
            alert('Please select at least one seat.');
            return;
        }

        // Prepare URL parameters
        const eventId = @Model.EventID;
        const selectedSeatsJson = encodeURIComponent(JSON.stringify(selectedSeats));
        const selectedTicketsJson = encodeURIComponent(JSON.stringify(selectedTickets));
        const totalAmount = selectedSeats.reduce((sum, seat) => sum + seat.price, 0);

        // Debug: Log URL parameters
        console.log('Proceeding to payment with URL parameters:');
        console.log('EventId:', eventId);
        console.log('SelectedSeats:', selectedSeatsJson);
        console.log('SelectedTickets:', selectedTicketsJson);
        console.log('TotalAmount:', totalAmount);

        // Navigate to payment page with URL parameters
        const paymentUrl = `/Home/Payment?eventId=${eventId}&selectedSeats=${selectedSeatsJson}&selectedTickets=${selectedTicketsJson}&totalAmount=${totalAmount}`;
        window.location.href = paymentUrl;
    }
</script>